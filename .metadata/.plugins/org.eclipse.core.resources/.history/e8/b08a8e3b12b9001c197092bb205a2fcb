/**
 * 
 */
package http.file.processor;

/**
 * @author home
 *
 */

import java.io.BufferedReader;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.StringReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLConnection;
import java.util.HashSet;
import java.util.LinkedList;
import java.util.Set;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;

import org.w3c.dom.Document;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.InputSource;


public class FileProcessor {

	/**
	 * @param args
	 */
	private static String urlString = "https://www.ncei.noaa.gov/data/normals-daily/access/";
	
	public static void main(String[] args) {
		LinkedList<String> fileNames = getListOfFiles();
		
		fileNames.forEach(name -> loadElevations(name));
	}
	
	public static void loadElevations(String name) {
		 URL url = null;
	     URLConnection connection;
	     InputStreamReader fileListStream;
		 String csvSplitBy = "\\",\\"";
	     
	     try {
				url = new URL(urlString + name);
			} catch (MalformedURLException e1) {
				// TODO Auto-generated catch block
				e1.printStackTrace();
			}
				
	}
	
	
	public static LinkedList getListOfFiles() {
		// TODO Auto-generated method stub
	      URL url = null;
	      URLConnection connection;
	      InputStreamReader fileListStream;
	      LinkedList<String> fileNames = new LinkedList<String>();
	      
		try {
			url = new URL(urlString);
		} catch (MalformedURLException e1) {
			// TODO Auto-generated catch block
			e1.printStackTrace();
		}
			
	    
	    BufferedReader buffer = null;
	    String line = "";

	        try {
	        	connection = url.openConnection();
	        	fileListStream = new InputStreamReader(connection.getInputStream());
	        	
	            buffer = new BufferedReader(fileListStream);
	            while ((line = buffer.readLine()) != null) {
	            	line = line.replace("&nbsp;", "");
	                //System.out.println(line);
	                DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance(); 
	                DocumentBuilder builder;  
	                try {  
	                    builder = factory.newDocumentBuilder();  
	                    if(line.contains(".csv")) {
	                    	Document document = builder.parse(new InputSource(new StringReader(line)));  
	                    	//System.out.println(document);
	                    	NodeList nodes = document.getChildNodes();
	                    	for(int i=0; i < nodes.getLength(); i++) {
	                    		Node node = nodes.item(i);
	                    		if(node.getFirstChild().getTextContent().contains(".csv")) {
	                    			String fileName = node.getFirstChild().getTextContent();
	                    			System.out.println(fileName);
	                    			fileNames.add(fileName.toString());
	                    			break;
	                    		}
	                    	}
	                    }
	                } catch (Exception e) {  
	                    e.printStackTrace();  
	                } 
	                
	            }

	        } catch (FileNotFoundException e) {
	            e.printStackTrace();
	        } catch (IOException e) {
	            e.printStackTrace();
	        } finally {
	            if (buffer != null) {
	                try {
	                    buffer.close();
	                } catch (IOException e) {
	                    e.printStackTrace();
	                }
	            }
	        }	         
	        
	        return fileNames;
	}

}
